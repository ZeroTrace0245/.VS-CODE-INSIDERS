<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tickets | Smart Facility</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script defer th:src="@{/js/app.js}"></script>
    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            setActiveNav("/tickets");
            const tableBody = document.getElementById("tickets-body");
            const filters = document.getElementById("filters");
            const form = document.getElementById("ticket-form");
            const uploadForm = document.getElementById("upload-form");
            let spaces = [];
            let page = 0;
            const size = 10;

            async function loadSpaces() {
                spaces = await apiFetch("/api/spaces");
                const select = document.getElementById("spaceId");
                const filterSelect = document.getElementById("filter-space");
                select.innerHTML = spaces.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
                filterSelect.innerHTML = '<option value="">All</option>' + spaces.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
            }

            function buildQuery() {
                const params = new URLSearchParams();
                params.set("page", page);
                params.set("size", size);
                const status = filters["filter-status"].value;
                const priority = filters["filter-priority"].value;
                const spaceId = filters["filter-space"].value;
                if (status) params.set("status", status);
                if (priority) params.set("priority", priority);
                if (spaceId) params.set("spaceId", spaceId);
                return params.toString();
            }

            async function loadTickets() {
                clearAlert("ticket-alert");
                tableBody.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";
                try {
                    const data = await apiFetch(`/api/tickets?${buildQuery()}`);
                    renderTable(data.content || []);
                    renderPager(data);
                } catch (err) {
                    showAlert("ticket-alert", err.message);
                    tableBody.innerHTML = "<tr><td colspan='7'>Unable to load tickets</td></tr>";
                }
            }

            function renderTable(items) {
                if (!items || items.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='7'>No tickets.</td></tr>";
                    return;
                }
                tableBody.innerHTML = items.map(t => `
                    <tr>
                        <td>${t.id}</td>
                        <td>${(t.space && t.space.name) || t.space?.id || ''}</td>
                        <td>${t.title}</td>
                        <td>${t.priority}</td>
                        <td><span class="badge status-${t.status}">${t.status}</span></td>
                        <td>${t.description?.substring(0,80) || ''}</td>
                        <td>
                            <button class="btn btn-ghost" data-status="IN_PROGRESS" data-id="${t.id}">In progress</button>
                            <button class="btn btn-ghost" data-status="RESOLVED" data-id="${t.id}">Resolve</button>
                            <button class="btn btn-danger" data-status="CLOSED" data-id="${t.id}">Close</button>
                        </td>
                    </tr>`).join("");
            }

            function renderPager(pageData) {
                const pager = document.getElementById("pager");
                pager.innerHTML = `Page ${pageData.number + 1} of ${pageData.totalPages || 1}`;
                document.getElementById("prev-page").disabled = pageData.first;
                document.getElementById("next-page").disabled = pageData.last;
            }

            filters.addEventListener("change", () => { page = 0; loadTickets(); });
            document.getElementById("prev-page").addEventListener("click", () => { page = Math.max(0, page - 1); loadTickets(); });
            document.getElementById("next-page").addEventListener("click", () => { page += 1; loadTickets(); });

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                clearAlert("ticket-alert");
                const payload = {
                    spaceId: parseInt(form.spaceId.value, 10),
                    title: form.title.value,
                    description: form.description.value,
                    priority: form.priority.value
                };
                try {
                    await apiFetch("/api/tickets", { method: "POST", body: JSON.stringify(payload) });
                    showAlert("ticket-alert", "Ticket created", "success");
                    form.reset();
                    loadTickets();
                } catch (err) {
                    showAlert("ticket-alert", err.message);
                }
            });

            tableBody.addEventListener("click", async (e) => {
                const btn = e.target.closest("button[data-status]");
                if (!btn) return;
                const id = btn.dataset.id;
                const status = btn.dataset.status;
                try {
                    await apiFetch(`/api/tickets/${id}/status`, { method: "PUT", body: JSON.stringify({ status }) });
                    showAlert("ticket-alert", `Ticket ${status.toLowerCase()}`, "success");
                    loadTickets();
                } catch (err) {
                    showAlert("ticket-alert", err.message);
                }
            });

            uploadForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                clearAlert("upload-alert");
                const ticketId = uploadForm.ticketId.value;
                const file = uploadForm.file.files[0];
                if (!file) { showAlert("upload-alert", "Choose a file"); return; }
                const fd = new FormData();
                fd.append("file", file);
                try {
                    const csrf = getCsrfToken();
                    await fetch(`/api/tickets/${ticketId}/attachments`, {
                        method: "POST",
                        credentials: "include",
                        headers: csrf ? { "X-XSRF-TOKEN": csrf } : {},
                        body: fd
                    }).then(res => {
                        if (!res.ok) throw new Error("Upload failed");
                    });
                    showAlert("upload-alert", "Uploaded", "success");
                    uploadForm.reset();
                } catch (err) {
                    showAlert("upload-alert", err.message);
                }
            });

            loadSpaces().then(loadTickets);
        });
    </script>
</head>
<body>
<header class="header">
    <div class="brand">Smart Facility</div>
    <nav class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/spaces">Spaces</a>
        <a href="/bookings">Bookings</a>
        <a href="/tickets" class="active">Tickets</a>
        <a href="/swagger-ui/index.html" target="_blank">API Docs</a>
        <a href="/auth/logout">Logout</a>
    </nav>
</header>
<main class="page">
    <div class="grid cols-2">
        <div class="card">
            <h2>Tickets</h2>
            <div id="ticket-alert"></div>
            <div id="filters" class="form-grid" style="margin-bottom:10px;">
                <div>
                    <label class="label" for="filter-status">Status</label>
                    <select id="filter-status" name="filter-status">
                        <option value="">All</option>
                        <option>OPEN</option><option>IN_PROGRESS</option><option>RESOLVED</option><option>CLOSED</option>
                    </select>
                </div>
                <div>
                    <label class="label" for="filter-priority">Priority</label>
                    <select id="filter-priority" name="filter-priority">
                        <option value="">All</option>
                        <option>LOW</option><option>MEDIUM</option><option>HIGH</option><option>CRITICAL</option>
                    </select>
                </div>
                <div>
                    <label class="label" for="filter-space">Space</label>
                    <select id="filter-space" name="filter-space"></select>
                </div>
            </div>
            <table>
                <thead><tr><th>ID</th><th>Space</th><th>Title</th><th>Priority</th><th>Status</th><th>Description</th><th>Actions</th></tr></thead>
                <tbody id="tickets-body"></tbody>
            </table>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                <div id="pager"></div>
                <div style="display:flex;gap:8px;">
                    <button id="prev-page" class="btn btn-ghost">Prev</button>
                    <button id="next-page" class="btn btn-ghost">Next</button>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Create ticket</h3>
            <form id="ticket-form" class="form-grid">
                <div>
                    <label class="label" for="spaceId">Space</label>
                    <select id="spaceId" name="spaceId" required></select>
                </div>
                <div>
                    <label class="label" for="priority">Priority</label>
                    <select id="priority" name="priority" required>
                        <option>LOW</option><option>MEDIUM</option><option>HIGH</option><option>CRITICAL</option>
                    </select>
                </div>
                <div style="grid-column:1/-1;">
                    <label class="label" for="title">Title</label>
                    <input id="title" name="title" required>
                </div>
                <div style="grid-column:1/-1;">
                    <label class="label" for="description">Description</label>
                    <textarea id="description" name="description" rows="3" required></textarea>
                </div>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button class="btn btn-primary" type="submit">Submit</button>
            </form>
            <h4 style="margin-top:18px;">Upload attachment</h4>
            <form id="upload-form" class="form-grid" enctype="multipart/form-data">
                <div>
                    <label class="label" for="ticketId">Ticket ID</label>
                    <input id="ticketId" name="ticketId" type="number" required>
                </div>
                <div>
                    <label class="label" for="file">File (max 5MB)</label>
                    <input id="file" name="file" type="file" accept="image/*,.pdf,.doc,.docx" required>
                </div>
                <button class="btn btn-ghost" type="submit">Upload</button>
            </form>
            <div id="upload-alert"></div>
        </div>
    </div>
</main>
</body>
</html>
