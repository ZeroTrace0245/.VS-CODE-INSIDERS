<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Bookings | Smart Facility</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script defer th:src="@{/js/app.js}"></script>
    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            setActiveNav("/bookings");
            const tableBody = document.getElementById("bookings-body");
            const filters = document.getElementById("filters");
            const form = document.getElementById("booking-form");
            const statusBtns = document.getElementById("status-actions");
            let spaces = [];
            let page = 0;
            const size = 10;

            async function loadSpaces() {
                spaces = await apiFetch("/api/spaces");
                const select = document.getElementById("spaceId");
                const filterSelect = document.getElementById("filter-space");
                select.innerHTML = spaces.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
                filterSelect.innerHTML = '<option value="">All</option>' + spaces.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
            }

            function buildQuery() {
                const params = new URLSearchParams();
                params.set("page", page);
                params.set("size", size);
                const spaceId = filters["filter-space"].value;
                const status = filters["filter-status"].value;
                const from = filters["filter-from"].value;
                const to = filters["filter-to"].value;
                if (spaceId) params.set("spaceId", spaceId);
                if (status) params.set("status", status);
                if (from) params.set("from", new Date(from).toISOString());
                if (to) params.set("to", new Date(to).toISOString());
                return params.toString();
            }

            async function loadBookings() {
                clearAlert("booking-alert");
                tableBody.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";
                try {
                    const query = buildQuery();
                    const data = await apiFetch(`/api/bookings?${query}`);
                    renderTable(data.content || []);
                    renderPager(data);
                } catch (err) {
                    showAlert("booking-alert", err.message);
                    tableBody.innerHTML = "<tr><td colspan='7'>Unable to load bookings</td></tr>";
                }
            }

            function renderTable(items) {
                if (!items || items.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='7'>No bookings.</td></tr>";
                    return;
                }
                tableBody.innerHTML = items.map(b => `
                    <tr>
                        <td>${b.id}</td>
                        <td>${(b.space && b.space.name) || b.space?.id || ''}</td>
                        <td>${b.startAt}</td>
                        <td>${b.endAt}</td>
                        <td>${b.purpose || ''}</td>
                        <td><span class="badge status-${b.status}">${b.status}</span></td>
                        <td>
                            <button class="btn btn-ghost" data-approve="${b.id}">Approve</button>
                            <button class="btn btn-danger" data-deny="${b.id}">Deny</button>
                        </td>
                    </tr>`).join("");
            }

            function renderPager(pageData) {
                const pager = document.getElementById("pager");
                pager.innerHTML = `Page ${pageData.number + 1} of ${pageData.totalPages || 1}`;
                document.getElementById("prev-page").disabled = pageData.first;
                document.getElementById("next-page").disabled = pageData.last;
            }

            filters.addEventListener("change", () => { page = 0; loadBookings(); });

            document.getElementById("prev-page").addEventListener("click", () => { page = Math.max(0, page - 1); loadBookings(); });
            document.getElementById("next-page").addEventListener("click", () => { page += 1; loadBookings(); });

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                clearAlert("booking-alert");
                const payload = {
                    spaceId: parseInt(form.spaceId.value, 10),
                    startAt: new Date(form.startAt.value).toISOString(),
                    endAt: new Date(form.endAt.value).toISOString(),
                    purpose: form.purpose.value
                };
                try {
                    await apiFetch("/api/bookings", { method: "POST", body: JSON.stringify(payload) });
                    showAlert("booking-alert", "Booking created", "success");
                    form.reset();
                    loadBookings();
                } catch (err) {
                    showAlert("booking-alert", err.message);
                }
            });

            tableBody.addEventListener("click", async (e) => {
                const approve = e.target.closest("button[data-approve]");
                const deny = e.target.closest("button[data-deny]");
                if (approve || deny) {
                    const id = approve ? approve.dataset.approve : deny.dataset.deny;
                    const status = approve ? "APPROVED" : "DENIED";
                    try {
                        await apiFetch(`/api/bookings/${id}/status`, { method: "PUT", body: JSON.stringify({ status }) });
                        showAlert("booking-alert", `Booking ${status.toLowerCase()}`, "success");
                        loadBookings();
                    } catch (err) {
                        showAlert("booking-alert", err.message);
                    }
                }
            });

            loadSpaces().then(loadBookings);
        });
    </script>
</head>
<body>
<header class="header">
    <div class="brand">Smart Facility</div>
    <nav class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/spaces">Spaces</a>
        <a href="/bookings" class="active">Bookings</a>
        <a href="/tickets">Tickets</a>
        <a href="/swagger-ui/index.html" target="_blank">API Docs</a>
        <a href="/auth/logout">Logout</a>
    </nav>
</header>
<main class="page">
    <div class="grid cols-2">
        <div class="card">
            <h2>Bookings</h2>
            <div id="booking-alert"></div>
            <div id="filters" class="form-grid" style="margin-bottom:10px;">
                <div>
                    <label class="label" for="filter-space">Space</label>
                    <select id="filter-space" name="filter-space"></select>
                </div>
                <div>
                    <label class="label" for="filter-status">Status</label>
                    <select id="filter-status" name="filter-status">
                        <option value="">All</option>
                        <option>PENDING</option><option>APPROVED</option><option>DENIED</option><option>CANCELLED</option>
                    </select>
                </div>
                <div>
                    <label class="label" for="filter-from">From</label>
                    <input id="filter-from" name="filter-from" type="datetime-local">
                </div>
                <div>
                    <label class="label" for="filter-to">To</label>
                    <input id="filter-to" name="filter-to" type="datetime-local">
                </div>
            </div>
            <table>
                <thead><tr><th>ID</th><th>Space</th><th>Start</th><th>End</th><th>Purpose</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="bookings-body"></tbody>
            </table>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                <div id="pager"></div>
                <div style="display:flex;gap:8px;">
                    <button id="prev-page" class="btn btn-ghost">Prev</button>
                    <button id="next-page" class="btn btn-ghost">Next</button>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Create booking</h3>
            <form id="booking-form" class="form-grid">
                <div>
                    <label class="label" for="spaceId">Space</label>
                    <select id="spaceId" name="spaceId" required></select>
                </div>
                <div>
                    <label class="label" for="startAt">Start</label>
                    <input id="startAt" name="startAt" type="datetime-local" required>
                </div>
                <div>
                    <label class="label" for="endAt">End</label>
                    <input id="endAt" name="endAt" type="datetime-local" required>
                </div>
                <div style="grid-column:1/-1;">
                    <label class="label" for="purpose">Purpose</label>
                    <textarea id="purpose" name="purpose" rows="3" required></textarea>
                </div>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button class="btn btn-primary" type="submit">Submit</button>
            </form>
            <p class="muted" style="margin-top:10px;">Managers/Admin can approve or deny bookings.</p>
        </div>
    </div>
</main>
</body>
</html>
