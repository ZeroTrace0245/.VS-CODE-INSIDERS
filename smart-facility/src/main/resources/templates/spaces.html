<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Spaces | Smart Facility</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script defer th:src="@{/js/app.js}"></script>
    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            setActiveNav("/spaces");
            const tableBody = document.getElementById("spaces-body");
            const form = document.getElementById("space-form");
            const submitBtn = document.getElementById("space-submit");
            let editId = null;

            async function loadSpaces() {
                clearAlert("space-alert");
                tableBody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
                try {
                    let data = await apiFetch("/api/spaces/all");
                    if (!Array.isArray(data)) data = await apiFetch("/api/spaces");
                    renderTable(data);
                } catch (err) {
                    showAlert("space-alert", err.message);
                    tableBody.innerHTML = "<tr><td colspan='5'>Unable to load spaces</td></tr>";
                }
            }

            function renderTable(items) {
                if (!items || items.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='5'>No spaces yet.</td></tr>";
                    return;
                }
                tableBody.innerHTML = items.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.location}</td>
                        <td>${s.capacity ?? ''}</td>
                        <td>${(s.features || []).join(', ')}</td>
                        <td>${s.active ? 'Yes' : 'No'}</td>
                        <td>
                            <button class="btn btn-ghost" data-edit="${s.id}">Edit</button>
                            <button class="btn btn-danger" data-del="${s.id}">Delete</button>
                        </td>
                    </tr>`).join("");
            }

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                clearAlert("space-alert");
                const payload = {
                    name: form.name.value,
                    location: form.location.value,
                    capacity: parseInt(form.capacity.value || "0", 10),
                    features: form.features.value ? form.features.value.split(',').map(f => f.trim()).filter(Boolean) : [],
                    active: form.active.checked
                };
                const method = editId ? "PUT" : "POST";
                const url = editId ? `/api/spaces/${editId}` : "/api/spaces";
                try {
                    await apiFetch(url, { method, body: JSON.stringify(payload) });
                    showAlert("space-alert", editId ? "Space updated" : "Space created", "success");
                    form.reset();
                    editId = null;
                    submitBtn.textContent = "Create";
                    loadSpaces();
                } catch (err) {
                    showAlert("space-alert", err.message);
                }
            });

            tableBody.addEventListener("click", async (e) => {
                const editBtn = e.target.closest("button[data-edit]");
                const delBtn = e.target.closest("button[data-del]");
                if (editBtn) {
                    const row = editBtn.closest("tr");
                    const cells = row.querySelectorAll("td");
                    editId = editBtn.dataset.edit;
                    form.name.value = cells[1].textContent;
                    form.location.value = cells[2].textContent;
                    form.capacity.value = cells[3].textContent;
                    form.features.value = cells[4].textContent;
                    form.active.checked = cells[5].textContent.trim() === 'Yes';
                    submitBtn.textContent = "Update";
                }
                if (delBtn) {
                    const id = delBtn.dataset.del;
                    if (!confirm("Delete this space?")) return;
                    try {
                        await apiFetch(`/api/spaces/${id}`, { method: "DELETE" });
                        showAlert("space-alert", "Space deleted", "success");
                        loadSpaces();
                    } catch (err) {
                        showAlert("space-alert", err.message);
                    }
                }
            });

            loadSpaces();
        });
    </script>
</head>
<body>
<header class="header">
    <div class="brand">Smart Facility</div>
    <nav class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/spaces" class="active">Spaces</a>
        <a href="/bookings">Bookings</a>
        <a href="/tickets">Tickets</a>
        <a href="/swagger-ui/index.html" target="_blank">API Docs</a>
        <a href="/auth/logout">Logout</a>
    </nav>
</header>
<main class="page">
    <div class="grid cols-2">
        <div class="card">
            <h2>Spaces</h2>
            <div id="space-alert"></div>
            <table>
                <thead>
                <tr><th>ID</th><th>Name</th><th>Location</th><th>Capacity</th><th>Features</th><th>Active</th><th></th></tr>
                </thead>
                <tbody id="spaces-body"></tbody>
            </table>
        </div>
        <div class="card">
            <h3 id="form-title">Create / Update Space</h3>
            <form id="space-form" class="form-grid">
                <div>
                    <label class="label" for="name">Name</label>
                    <input id="name" name="name" required>
                </div>
                <div>
                    <label class="label" for="location">Location</label>
                    <input id="location" name="location" required>
                </div>
                <div>
                    <label class="label" for="capacity">Capacity</label>
                    <input id="capacity" name="capacity" type="number" min="1" required>
                </div>
                <div>
                    <label class="label" for="features">Features (comma separated)</label>
                    <input id="features" name="features" placeholder="Projector, Whiteboard">
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input id="active" name="active" type="checkbox" checked>
                    <label for="active">Active</label>
                </div>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button id="space-submit" class="btn btn-primary" type="submit">Create</button>
            </form>
        </div>
    </div>
</main>
</body>
</html>
